import{c as k,j as e,h as U,r,i as G,a as H,M as Q,k as Y,l as q,m as L,_ as b,n as E,o as J,A as W,B as I,T as R,p as X,q as K,t as Z,v as ee,w as te,S as T,I as _,x as se}from"./index-VKYCie2F.js";import{m as re,A as oe,C as ne,a as ae,N as D}from"./AppLayout-bYmM-5do.js";import{M as ie,L as le}from"./MenuItem-ClZoCDlD.js";import{R as ce}from"./RandereAttachment-UvYrSsE6.js";import{u as de,a as ge}from"./hook-WB9xNPVN.js";import{c as me}from"./index-BynNlPMo.js";import"./Toolbar-DijeMYcs.js";import"./Notifications-HpfkH6kg.js";import"./ExitToApp-DuLDxxpq.js";const ue=k(e.jsx("path",{d:"M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6z"}),"AttachFile"),pe=k(e.jsx("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2M8.5 13.5l2.5 3.01L14.5 12l4.5 6H5z"}),"Image"),he=k(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send"),xe=({anchorEl:n,chatId:a})=>{const{isFileMenu:t}=U(o=>o.misc),u=r.useRef(null);r.useRef(null),r.useRef(null);const[x]=G(),c=H(),l=()=>c(L(!1));console.log("Sending chatId 1 :",a);const p=()=>{var o;return(o=u.current)==null?void 0:o.click()},h=async(o,i)=>{console.log("Sending chatId 2 :",a);const d=Array.from(o.target.files);if(d.length<=0)return;if(d.length>5)return b.error(`You can only send 5 ${i} at a time`);c(E(!0));const f=b.loading(`Sending ${i}...`);l();try{const g=new FormData;g.append("chatId",a),d.forEach(m=>g.append("files",m));const S=await x(g);if(!a){b.error("Chat ID is missing. Please select a chat.");return}S.data?b.success(`${i} sent Successfully`,{id:f}):b.error(`Failed to send ${i}`,{id:f})}catch(g){b.error(g,{id:f}),console.error("Error details:",g)}finally{c(E(!1))}};return e.jsx(Q,{anchorEl:n,open:t,onClose:l,sx:{bgcolor:"transparent",backdropFilter:"blur(1px)","& .MuiPaper-root":{backgroundColor:"rgba(0, 0, 0, 0.5)",backdropFilter:"blur(5px)",boxShadow:"none"}},children:e.jsx("div",{style:{width:"10rem",backgroundColor:"transparent"},children:e.jsx(Y,{children:e.jsxs(ie,{onClick:p,children:[e.jsx(q,{title:"Image",children:e.jsx(pe,{sx:{color:"white"}})}),e.jsx(le,{style:{color:"white",marginLeft:"0.5rem"},children:"Image"}),e.jsx("input",{type:"file",multiple:!0,accept:"image/png, image/jpeg, image/gif",style:{display:"none"},onChange:o=>{console.log("onChange fired"),console.log("File selected:",o.target.files),h(o,"Image")},ref:u})]})})})})},fe=({message:n,user:a})=>{const{sender:t,content:u,attachments:x=[],createdAt:c}=n,l=(t==null?void 0:t._id)===(a==null?void 0:a._id),p=J(c).fromNow();return e.jsxs(re.div,{initial:{opacity:0,x:"-100%"},whileInView:{opacity:1,x:0},style:{alignSelf:l?"flex-end":"flex-start",color:"white",width:"fit-content",marginBottom:"0.5rem"},children:[!l&&t&&e.jsx(W,{sx:{width:"25px",height:"25px",marginBottom:"0.4rem"},src:t.avatar||"",alt:t.name,children:!t.avatar&&t.name&&t.name[0].toUpperCase()}),e.jsxs(I,{sx:{backgroundColor:l?"#FF6968":"rgba(0,0,0,0.2)",backdropFilter:"blur(15px)",borderRadius:"0.5rem",textAlign:l?"right":"left"},children:[u&&e.jsx(R,{sx:{padding:"0.4rem"},children:u}),x.length>0&&x.map((h,o)=>{const i=h.url,d=X(i);return e.jsx(I,{sx:{backgroundColor:"none"},children:e.jsx("a",{href:i,target:"_blank",download:!0,style:{color:"black"},children:ce(d,i)})},o)})]}),e.jsx(R,{marginTop:"0.1rem",textAlign:"right",fontSize:"10px",color:"white",children:p})]})},be=r.memo(fe),je=({chatId:n,user:a={currentUser}})=>{var v,C,F,A;const t=K(),u=H(),x=r.useRef(null),c=r.useRef(null),l=r.useRef(null),[p,h]=r.useState(""),[o,i]=r.useState([]),[d,f]=r.useState(1),[g,S]=r.useState(null),m=Z({chatId:n,skip:!n}),M=ee({chatId:n,page:d}),{data:w,setData:V}=me(c,(v=M.data)==null?void 0:v.totalPages,d,f,(C=M.data)==null?void 0:C.messages),B=[{isError:m.isError,error:m.error},{isError:M.isError,error:M.error}],y=(A=(F=m==null?void 0:m.data)==null?void 0:F.chat)==null?void 0:A.members,z=s=>{u(L(!0)),S(s.currentTarget)},$=s=>{if(s.preventDefault(),!p.trim())return;const j={chatId:n,members:y,message:p,timestamp:new Date().toISOString()};t.emit(D,j),h("")};r.useEffect(()=>(t.emit(ne,{userId:a._id,members:y}),()=>{i([]),h(""),V([]),f(1),t.emit(ae,{userId:a._id,members:y})}),[n]);const N=r.useCallback(s=>{s.chatId===n&&i(j=>[...j,s.message])},[n]),O={[D]:N};de(t,O),ge(B);const P=[...w,...o].sort((s,j)=>new Date(s.timestamp)-new Date(j.timestamp));return r.useEffect(()=>{var s;o.length>0&&((s=l.current)==null||s.scrollIntoView({behavior:"smooth"}))},[o]),r.useEffect(()=>{w.length>0&&(c.current.scrollBottom=1)},[w]),m.isLoading?e.jsx(te,{}):e.jsxs(r.Fragment,{children:[e.jsxs(T,{ref:c,boxSizing:"border-box",padding:"1rem",spacing:"1rem",bgcolor:"rgba(0, 0, 0, 0.4)",borderRight:"1px solid gray",height:"90%",sx:{backdropFilter:"blur(5px)",overflowX:"hidden",overflowY:"auto","&::-webkit-scrollbar":{width:"4px"},"&::-webkit-scrollbar-thumb":{backgroundColor:"gray",borderRadius:"4px"}},children:[P.map(s=>e.jsx(be,{message:s,user:a},s._id)),e.jsx("div",{ref:l})]}),e.jsx("form",{style:{height:"10%"},onSubmit:$,children:e.jsxs(T,{direction:"row",height:"100%",padding:"0.8rem",alignItems:"center",position:"relative",bgcolor:"rgba(0, 0, 0, 0.4)",sx:{borderTop:"1px solid gray",borderRight:"1px solid gray",backdropFilter:"blur(5px)"},children:[e.jsx(_,{sx:{position:"absolute",left:"0.4rem",color:"white","&:hover":{rotate:"-90deg"}},onClick:z,ref:x,children:e.jsx(ue,{})}),e.jsx(se,{placeholder:"Type Message Here...",value:p,onChange:s=>h(s.target.value)}),e.jsx(_,{type:"submit",sx:{color:"white",marginLeft:"0.5rem",padding:"0.5rem","&:hover":{background:"gray",rotate:"-90deg"}},children:e.jsx(he,{})})]})}),e.jsx(xe,{anchorEl:g,chatId:n})]})},Ee=oe()(je);export{Ee as default};
